<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Level Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* 3. Menyesuaikan warna tema dari Telegram */
        :root {
            --tg-bg: #ffffff;
            --tg-text: #000000;
            --tg-button: #3390ec;
            --tg-button-text: #ffffff;
            --tg-hint: #999999;
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
        }
        .btn-primary {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
        }
        .progress-bar-fill {
            background-color: var(--tg-button);
        }
    </style>
</head>
<body class="font-sans antialiased">
    <div id="app" class="max-w-md mx-auto p-4">

        <div id="welcome-container" class="text-center space-y-4">
            <h1 id="welcome-message" class="text-3xl font-bold">Hai!</h1>
            <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg">
                <h2 id="level-display" class="text-2xl font-semibold">Level 0</h2>
                <p id="progress-text" class="text-sm" style="color: var(--tg-hint);">Progres: 0/10</p>
                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="progress-bar-fill h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <p style="color: var(--tg-hint);">Jawab pertanyaan dengan benar untuk naik level!</p>
            <div class="space-y-3">
                <button id="start-quiz-btn" class="btn-primary w-full py-3 rounded-lg font-semibold text-lg">Mulai Kuis</button>
                <button id="show-leaderboard-btn" class="bg-slate-200 dark:bg-slate-700 w-full py-3 rounded-lg font-semibold text-lg">Lihat Leaderboard</button>
            </div>
        </div>

        <div id="quiz-container" class="hidden text-center space-y-4">
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                <div id="timer-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-1000 linear" style="width: 100%"></div>
            </div>
            <h2 id="question" class="text-xl font-semibold min-h-[80px]">Membuat soal baru...</h2>
            <div id="options-container" class="space-y-3"></div>
            <p id="feedback" class="font-bold min-h-[24px]"></p>
        </div>

        <div id="leaderboard-container" class="hidden space-y-4">
            <h2 class="text-2xl font-bold text-center">üèÜ Leaderboard üèÜ</h2>
            <div id="leaderboard-body" class="space-y-2"></div>
            <button id="back-to-menu-btn" class="bg-slate-200 dark:bg-slate-700 w-full py-3 rounded-lg font-semibold">Kembali</button>
        </div>
    </div>

    <script>
        // --- Referensi Elemen & Variabel Global ---
        const welcomeContainer = document.getElementById('welcome-container');
        const quizContainer = document.getElementById('quiz-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const questionEl = document.getElementById('question');
        const optionsContainerEl = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const levelDisplay = document.getElementById('level-display');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const timerBar = document.getElementById('timer-bar');
        
        let bankSoal = [], soalSekarangIndex = 0, skor = 0, tgUser = null;
        let currentUser = { level: 0, xp: 0, xp_needed: 10 };
        let timerInterval; // Variabel untuk menyimpan interval timer

        // --- Logika Navigasi Halaman ---
        function showPage(page) {
            [welcomeContainer, quizContainer, leaderboardContainer].forEach(p => p.classList.add('hidden'));
            page.classList.remove('hidden');
        }

        document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
        document.getElementById('show-leaderboard-btn').addEventListener('click', showLeaderboard);
        document.getElementById('back-to-menu-btn').addEventListener('click', () => showPage(welcomeContainer));

        // --- Logika Timer ---
        function startTimer() {
            clearInterval(timerInterval);
            timerBar.classList.remove('transition-all');
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#22c55e'; // green-500

            let timeLeft = 30;
            setTimeout(() => timerBar.classList.add('transition-all'), 100); // Re-enable transition

            timerInterval = setInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 30) * 100;
                timerBar.style.width = `${percentage}%`;
                if (timeLeft < 10) timerBar.style.backgroundColor = '#ef4444'; // red-500
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    pilihJawaban(null); // Anggap jawaban salah jika waktu habis
                }
            }, 1000);
        }

        // --- Logika Utama Kuis ---
        async function startQuiz() {
            showPage(quizContainer);
            questionEl.innerText = 'Membuat soal baru dari AI, mohon tunggu...';
            try {
                const response = await fetch(`/api/questions?level=${currentUser.level}`);
                if (!response.ok) throw new Error('Gagal memuat soal.');
                bankSoal = await response.json();
                soalSekarangIndex = 0; skor = 0;
                muatSoal();
            } catch (error) { questionEl.innerText = 'Gagal memuat kuis.'; }
        }
        
        function muatSoal() {
            optionsContainerEl.innerHTML = '';
            feedbackEl.innerText = '';
            if (soalSekarangIndex >= bankSoal.length) {
                clearInterval(timerInterval); // Hentikan timer di akhir kuis
                questionEl.innerText = `Kuis Selesai!`;
                optionsContainerEl.innerHTML = `<p class="text-lg">Kamu menjawab <strong>${skor}</strong> soal dengan benar!</p><button class="btn-primary w-full py-3 mt-4 rounded-lg font-semibold" onclick="showPage(welcomeContainer)">Selesai</button>`;
                submitScore();
                return;
            }
            const soal = bankSoal[soalSekarangIndex];
            questionEl.innerText = soal.pertanyaan;
            soal.opsi.forEach(opsi => {
                const button = document.createElement('button');
                button.innerText = opsi;
                button.className = 'w-full py-3 rounded-lg border-2 border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800';
                button.onclick = () => pilihJawaban(opsi);
                optionsContainerEl.appendChild(button);
            });
            startTimer(); // Mulai timer saat soal baru dimuat
        }
        
        function pilihJawaban(jawabanDipilih) {
            clearInterval(timerInterval); // Hentikan timer saat jawaban dipilih
            Array.from(optionsContainerEl.children).forEach(btn => btn.disabled = true);
            const soal = bankSoal[soalSekarangIndex];
            
            if (jawabanDipilih === null) {
                feedbackEl.innerText = `Waktu habis! Jawaban: ${soal.jawabanBenar}`;
                feedbackEl.style.color = '#ef4444';
            } else if (jawabanDipilih === soal.jawabanBenar) {
                feedbackEl.innerText = "Benar! üéâ";
                feedbackEl.style.color = '#22c55e';
                skor++;
            } else {
                feedbackEl.innerText = `Salah. Jawaban benar: ${soal.jawabanBenar}`;
                feedbackEl.style.color = '#ef4444';
            }
            soalSekarangIndex++;
            setTimeout(muatSoal, 2000);
        }

        // --- Logika User & Leaderboard ---
        async function fetchUserProgress() { /* ... kode sama persis seperti sebelumnya ... */ }
        function updateProgressUI() { /* ... kode sama persis seperti sebelumnya ... */ }
        async function submitScore() { /* ... kode sama persis seperti sebelumnya ... */ }
        
        async function showLeaderboard() {
            showPage(leaderboardContainer);
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<p>Memuat data...</p>';
            try {
                const response = await fetch('/api/leaderboard');
                if (!response.ok) throw new Error('Gagal memuat leaderboard.');
                const data = await response.json();
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<p class="text-center" style="color: var(--tg-hint);">Belum ada skor.</p>';
                } else {
                    data.forEach(p => {
                        tbody.innerHTML += `
                            <div class="flex items-center justify-between bg-slate-100 dark:bg-slate-800 p-3 rounded-lg">
                                <span class="font-bold text-lg">${p.rank}.</span>
                                <span class="flex-1 text-left ml-4">${p.first_name}</span>
                                <span class="font-semibold">Lv. ${p.level}</span>
                            </div>
                        `;
                    });
                }
            } catch (error) { tbody.innerHTML = '<p class="text-center text-red-500">Gagal memuat data.</p>'; }
        }

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            // Salin sisa kode inisialisasi dari sebelumnya di sini
            // (mengambil data user, mengatur tema, dll)
        });
    </script>
</body>
</html>
